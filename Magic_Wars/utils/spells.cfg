#define MW_COST NAME MANA
	{VARIABLE $counter|.original_cost.{NAME} {MANA}}
	{VARIABLE $counter|.cost.{NAME} {MANA}}
#enddef

#define MW_SET_SPELL_MENU_AND_PARAMETERS
	{VARIABLE counter 1}
	[while]
		{MW_VARIABLE counter less_than 10}
		[do]
			[if]
				{MW_VARIABLE mage_sides contains $counter}
				[then]
					{VARIABLE $counter|.spells.speaker narrator}
					{VARIABLE $counter|.spells.side_for $counter}
					{VARIABLE_OP $counter|.spells.message literal _"These are your currently available spells. ($$side_number|.mana mana available)"}
					{VARIABLE_OP $counter|.discarded_spells.message literal _"These are your discarded spells."}
					{VARIABLE $counter|.discarded_spells.speaker narrator}
					{VARIABLE $counter|.discarded_spells.side_for $counter}
					{VARIABLE_OP $counter|.hidden_spells.message literal _"These are your hidden spells."}
					{VARIABLE $counter|.hidden_spells.speaker narrator}
					{VARIABLE $counter|.hidden_spells.side_for $counter}
					{VARIABLE_OP $counter|.shown_curses.message literal _"These are curses you are currently afflicted by."}
					{VARIABLE $counter|.shown_curses.speaker narrator}
					{VARIABLE $counter|.shown_curses.side_for $counter}
					[set_variables]
						name=$counter|.spells.option
						mode=append
						[value]
							message=_"Don't cast a spell"
							[command]
								{VARIABLE finished yes}
							[/command]
						[/value]
					[/set_variables]
					[set_variables]
						name=$counter|.discarded_spells.option
						mode=append
						[value]
							message=_"Done looking"
							[command]
								{VARIABLE finished yes}
							[/command]
						[/value]
					[/set_variables]
					[set_variables]
						name=$counter|.hidden_spells.option
						mode=append
						[value]
							message=_"Done looking"
							[command]
								{VARIABLE finished yes}
							[/command]
						[/value]
					[/set_variables]
					[set_variables]
						name=$counter|.shown_curses.option
						mode=append
						[value]
							message=_"Done looking"
							[command]
								{VARIABLE finished yes}
							[/command]
						[/value]
					[/set_variables]
				[/then]
			[/if]
			{MW_COST fireball 6}
			{MW_COST snakebite 10}
			{MW_COST frost_blast 11}
			{MW_COST thunderbolt 14}
			{MW_COST shadow_strike 17}
			{MW_COST null_and_void 8}
			{MW_COST dispel_malice 7}
			{MW_COST debunk 10}
			{MW_COST reap 15}
			{MW_COST recall_command 12}
			{MW_COST earthquake 44}
			{MW_COST smite 11}
			{MW_COST tremors 25}
			{MW_COST combustibolt 5}
			{VARIABLE_OP counter add 1}
		[/do]
	[/while]
#enddef

# This gets rid of a spell from a side's roster.

#define MW_CLEAR_SPELL SIDE NAME
	{VARIABLE spell_cleared no}
	{FOREACH {SIDE}|.spells.option u}
		[if]
			{MW_VARIABLE {SIDE}|.spells.option[$u].name equals {NAME}}
			[then]
				[if]
					{MW_VARIABLE spell_cleared not_equals yes}
					[then]
						{CLEAR_VARIABLE {SIDE}|.spells.option[$u]}
						{VARIABLE spell_cleared yes}
					[/then]
				[/if]
			[/then]
		[/if]
	{NEXT u}
	{CLEAR_VARIABLE spell_cleared}
#enddef

# This removes a spell from a side's roster and puts it in its discard pile.

#define MW_DISCARD_SPELL SIDE NAME
	{VARIABLE spell_discarded no}
	{FOREACH {SIDE}|.spells.option i}
		[if]
			{MW_VARIABLE {SIDE}|.spells.option[$i].name equals {NAME}}
			[then]
				[if]
					{MW_VARIABLE spell_discarded not_equals yes}
					[then]
						[set_variables]
							name={SIDE}|.discarded_spells.option
							mode=append
							[value]
								name={NAME}
								message=${SIDE}|.spells.option[$i].message
							[/value]
						[/set_variables]
					[/then]
				[/if]
				{VARIABLE spell_discarded yes}
			[/then]
		[/if]
	{NEXT i}
	{MW_CLEAR_SPELL {SIDE} {NAME}}
#enddef

# This destroys a discarded spell - that is, it removes it from the discard pile.

#define MW_DESTROY_SPELL SIDE NAME
	{VARIABLE spell_destroyed no}
	{FOREACH {SIDE}|.discarded_spells.option z}
		[if]
			{MW_VARIABLE {SIDE}|.discarded_spells.option[$z].name equals {NAME}}
			[then]
				[if]
					{MW_VARIABLE spell_destroyed not_equals yes}
					[then]
						{CLEAR_VARIABLE {SIDE}|.discarded_spells.option[$z]}
						{VARIABLE spell_destroyed yes}
					[/then]
				[/if]
			[/then]
		[/if]
	{NEXT z}
	{CLEAR_VARIABLE spell_destroyed}
#enddef

#define MW_DISARM_HIDDEN_SPELL SIDE NAME
	{VARIABLE spell_destroyed no}
	{FOREACH {SIDE}|.hidden_spells.option x}
		[if]
			{MW_VARIABLE {SIDE}|.hidden_spells.option[$x].name equals {NAME}}
			[then]
				[if]
					{MW_VARIABLE spell_destroyed not_equals yes}
					[then]
						{CLEAR_VARIABLE {SIDE}|.hidden_spells.option[$x]}
						{VARIABLE spell_destroyed yes}
					[/then]
				[/if]
			[/then]
		[/if]
	{NEXT x}
	{CLEAR_VARIABLE spell_destroyed}
#enddef

#define MW_REMOVE_CURSE SIDE NAME
	{VARIABLE curse_removed no}
	{FOREACH {SIDE}|.curses.option v}
		[if]
			{MW_VARIABLE {SIDE}|.curses.option[$v].name equals {NAME}}
			[then]
				[if]
					{MW_VARIABLE curse_removed not_equals yes}
					[then]
						{CLEAR_VARIABLE {SIDE}|.curses.option[$v]}
						{VARIABLE curse_removed yes}
					[/then]
				[/if]
			[/then]
		[/if]
	{NEXT v}
	{CLEAR_VARIABLE curse_removed}
#enddef

#define MW_COUNTER_TYPE TYPE
	[if]
		{MW_VARIABLE $side_number|.curses.option[$i].counter_for.{TYPE} equals yes}
		[then]
			[if]
				{MW_VARIABLE spell_cast.{TYPE} equals yes}
				[then]
					{VARIABLE spell_cast.canceled yes}
					[set_variables]
						name=spell_cast.side
						mode=append
						[value]
							name=$$side_number|.curses.option[$y].name
							side=$$side_number|.curses.option[$y].casting_side
						[/value]
					[/set_variables]
					[if]
						{MW_VARIABLE $side_number|.curses.option[$y].destroy equals yes}
						[then]
							{VARIABLE spell_cast.destroyed yes}
						[/then]
					[/if]
				[/then]
			[/if]
		[/then]
	[/if]
#enddef

#define MW_CHECK_FOR_COUNTERS
	{CLEAR_VARIABLE spell_cast.canceled}
	{CLEAR_VARIABLE spell_cast.destroyed}
	{VARIABLE spell_cast.canceled no}
	{FOREACH $side_number|.curses.option y}
		[if]
			{MW_VARIABLE $side_number|.curses.option.counter equals yes}
			[then]
				[if]
# If the counter isn't specific, it will hit the first spell cast.
					{MW_VARIABLE $side_number|.curses.option[$y].counter_for.length equals 0}
					[then]
						{VARIABLE spell_cast.canceled yes}
						[set_variables]
							name=spell_cast.side
							mode=append
							[value]
								name=$$side_number|.curses.option[$y].name
								side=$$side_number|.curses.option[$y].casting_side
							[/value]
						[/set_variables]
						[if]
							{MW_VARIABLE $side_number|.curses.option[$y].destroy equals yes}
							[then]
								{VARIABLE spell_cast.destroyed yes}
							[/then]
						[/if]
					[/then]
				[/if]
				{MW_COUNTER_TYPE damaging}
				{MW_COUNTER_TYPE debuff}
			[/then]
		[/if]
	{NEXT y}
	[if]
		{MW_VARIABLE spell_cast.canceled equals yes}
		[then]
# If several sides can counter the same spell, one is chosen at random.
			{VARIABLE_OP side_that_counters rand 1..$spell_cast.side.length}
			{VARIABLE_OP side_that_counters add -1}
			{VARIABLE spell_to_destroy $spell_cast.side[$side_that_counters].name}
			{VARIABLE side_to_remove $spell_cast.side[$side_that_counters].casting_side}
			{MW_DISARM_HIDDEN_SPELL $side_to_remove $spell_to_destroy}
			{MW_REMOVE_CURSE $side_number $spell_to_destroy}
			{MW_STORE_MAGE $side_number}
			[scroll_to]
				x,y=$mage.x,$mage.y
			[/scroll_to]
			{THUNDER (
				[floating_text]
					x,y=$mage.x,$mage.y
					text="<span color='red'>Spell canceled</span>"
				[/floating_text]
			)}
			[message]
				speaker=narrator
				side_for=$side_to_remove
				message= _ "Your spell, $spell_cast.side[$side_that_counters].name|, has canceled side $side_number|'s spell."
			[/message]
			{CLEAR_VARIABLE mage}
		[/then]
	[/if]
#enddef

#define MW_DESTROY_SPELLS_TO_FUEL AMOUNT
	{VARIABLE spells_left_to_destroy {AMOUNT}}
	[while]
		{MW_VARIABLE spells_left_to_destroy greater_than 0}
		[do]
			{VARIABLE select_discarded_spells.speaker narrator}
			{VARIABLE select_discarded_spells.side_for $side_number}
			{VARIABLE_OP select_discarded_spells.message literal _"Which spells do you wish to destroy to fuel this spell? $spells_left_to_destroy| spells remaining)"}
			{FOREACH $side_number|.discarded_spells.option i}
				[if]
					{MW_VARIABLE i greater_than 0}
					[then]
						[set_variables]
							name=select_discarded_spells.option
							mode=append
							[value]
								name=$$side_number|.discarded_spells.option[$i].name
								message=$$side_number|.discarded_spells.option[$i].message
								[command]
									{VARIABLE spell_to_destroy $$side_number|.discarded_spells.option[$i].name}
									{VARIABLE_OP spells_left_to_destroy add -1}
								[/command]
							[/value]
						[/set_variables]
					[/then]
				[/if]
			{NEXT i}
			[insert_tag]
				name=message
				variable=select_discarded_spells
			[/insert_tag]
			{MW_DESTROY_SPELL $side_number $spell_to_destroy}
			{CLEAR_VARIABLE select_discarded_spells}
		[/do]
	[/while]
#enddef

#define MW_SPELL_EVENTS
	[event]
		name=Fireball
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.name "Fireball"}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=fire.wav
				[/sound]
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=12
					damage_type=fire
					fire_event=yes
					animate=yes
				[/harm_unit]
				{CLEAR_VARIABLE target}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Fireball}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Combustibolt
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.name "Fireball"}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{MW_DESTROY_SPELLS_TO_FUEL 4}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=explosion.ogg
				[/sound]
				[harm_unit]
					[filter]
						{MW_NOT_SPELLPROOF}
						{MW_ENEMY_OF $side_number}
						canrecruit=no
						[filter_location]
							x,y=$target.x,$target.y
							radius=2
						[/filter_location]
					[/filter]
					amount=14
					damage_type=fire
					fire_event=yes
					animate=yes
				[/harm_unit]
				{CLEAR_VARIABLE target}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Combustibolt}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Smite
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.name "Smite"}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=magic-holy-1.ogg
				[/sound]
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=10
					damage_type=arcane
					fire_event=yes
					animate=yes
				[/harm_unit]
				{MW_STORE_UNIT victim x,y=$target.x,$target.y}
				[if]
					{MW_VARIABLE victim.resistance.arcane greater_than 100}
					{MW_VARIABLE victim.hitpoints greater_than 0}
					[then]
						{VARIABLE victim.variables.skip_turn yes}
						{MW_UNSTORE_UNIT_TEXT victim _"Smited" 255,0,0}
					[/then]
				[/if]
				{CLEAR_VARIABLE target}
				{CLEAR_VARIABLE victim}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Smite}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Shadow Strike
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.debuff yes}
		{VARIABLE spell_cast.name "Shadow Strike"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=claws.ogg
				[/sound]
				[if]
					[have_unit]
						x,y=$target.x,$target.y
						[filter_adjacent]
							is_enemy=yes
						[/filter_adjacent]
					[/have_unit]
					[then]
						{VARIABLE harm_amount 12}
					[/then]
					[else]
						{VARIABLE harm_amount 6}
					[/else]
				[/if]
				[if]
					[have_unit]
						x,y=$target.x,$target.y
						[filter_wml]
							[status]
								not_living=yes
							[/status]
						[/filter_wml]
					[/have_unit]
					[then]
						[harm_unit]
							[filter]
								x,y=$target.x,$target.y
							[/filter]
							amount=$harm_amount
							damage_type=blade
							fire_event=yes
							animate=yes
						[/harm_unit]
					[/then]
					[else]
						[harm_unit]
							[filter]
								x,y=$target.x,$target.y
							[/filter]
							amount=$harm_amount
							damage_type=blade
							fire_event=yes
							animate=yes
							unhealable=yes
						[/harm_unit]
					[/else]
				[/if]
				[if]
					[have_unit]
						x,y=$target.x,$target.y
						[not]
							[filter_wml]
								[status]
									not_living=yes
								[/status]
							[/filter_wml]
						[/not]
					[/have_unit]
					[then]
						{MW_STORE_UNIT target_unit x,y=$target.x,$target.y}
						{VARIABLE target_unit.status.deepwound4 yes}
						{CLEAR_VARIABLE target_unit.status.deepwound3}
						{CLEAR_VARIABLE target_unit.status.deepwound2}
						{CLEAR_VARIABLE target_unit.status.deepwound1}
						[delay]
							time=200
						[/delay]
						{MW_UNSTORE_UNIT_TEXT target_unit "deeply wounded" 255,0,0}
					[/then]
				[/if]
				{CLEAR_VARIABLE target_unit}
				{CLEAR_VARIABLE target}
				{CLEAR_VARIABLE harm_amount}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Shadow Strike"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Thunderbolt
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.name "Thunderbolt"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[if]
					[have_location]
						x,y=$target.x,$target.y
						terrain=W*
					[/have_location]
					[or]
						{MW_VARIABLE unit.flying equals yes}
					[/or]
					[then]
						{VARIABLE harm_amount 30}
					[/then]
					[else]
						{VARIABLE harm_amount 15}
					[/else]
				[/if]
				[sound]
					name=lightning.ogg
				[/sound]
				[item]
					x,y=$target.x,$target.y
					halo=halo/lightning-bolt-1-1.png
				[/item]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y=$target.x,$target.y
				[/remove_item]
				[item]
					x,y=$target.x,$target.y
					halo=halo/lightning-bolt-1-2.png
				[/item]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y=$target.x,$target.y
				[/remove_item]
				[item]
					x,y=$target.x,$target.y
					halo=halo/lightning-bolt-1-3.png
				[/item]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y=$target.x,$target.y
				[/remove_item]
				[item]
					x,y=$target.x,$target.y
					halo=halo/lightning-bolt-1-4.png
				[/item]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y=$target.x,$target.y
				[/remove_item]
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=$harm_amount
					damage_type=fire
					fire_event=yes
					animate=yes
				[/harm_unit]
				[if]
					[have_location]
						x,y=$target.x,$target.y
						terrain=W*
					[/have_location]
					[then]
						[harm_unit]
							[filter]
								{MW_ENEMY_OF $side_number}
								{MW_NOT_SPELLPROOF}
								[filter_location]
#Not the original hex, we don't want to damage the original target twice.
									[not]
										x,y=$target.x,$target.y
									[/not]
									[and]
										x,y=$target.x,$target.y
										radius=1
									[/and]
									[and]
										terrain=W*
									[/and]
								[/filter_location]
							[/filter]
							amount=$harm_amount
							damage_type=fire
							fire_event=yes
							animate=yes
						[/harm_unit]
					[/then]
				[/if]
				{CLEAR_VARIABLE target}
				{CLEAR_VARIABLE harm_amount}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Thunderbolt}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Earthquake
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.alter_terrain yes}
		{VARIABLE spell_cast.name "Earthquake"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				{QUAKE rumble.ogg}
				[harm_unit]
					[filter]
						canrecruit=no
						[not]
							[filter_wml]
								flying=yes
							[/filter_wml]
						[/not]
						{MW_NOT_SPELLPROOF}
						[filter_location]
							x,y=$target.x,$target.y
							radius=1
						[/filter_location]
					[/filter]
					amount=18
					damage_type=impact
					fire_event=yes
					animate=yes
				[/harm_unit]
				[store_locations]
					x,y=$target.x,$target.y
					radius=1
					variable=affected_location
				[/store_locations]
				{FOREACH affected_location i}
					[if]
						{MW_VARIABLE affected_location[$i].terrain contains Mm}
						[then]
							[sound]
								name=club.ogg
							[/sound]
							[terrain]
								x,y=$affected_location[$i].x,$affected_location[$i].y
								terrain=Hh
							[/terrain]
							[harm_unit]
								[filter]
									x,y=$affected_location[$i].x,$affected_location[$i].y
									[not]
										[filter_wml]
											flying=yes
										[/filter_wml]
									[/not]
								[/filter]
								{MW_NOT_SPELLPROOF}
								amount=18
								damage_type=impact
								fire_event=yes
								animate=yes
							[/harm_unit]
						[/then]
						[else]
							[if]
								{MW_VARIABLE affected_location[$i].terrain contains ^V}
								[not]
									{MW_VARIABLE affected_location[$i].terrain contains W}
								[/not]
								[then]
									[sound]
										name=club.ogg
									[/sound]
									[terrain]
										x,y=$affected_location[$i].x,$affected_location[$i].y
										terrain=^Vr
										layer=overlay
									[/terrain]
									[harm_unit]
										[filter]
											x,y=$affected_location[$i].x,$affected_location[$i].y
											[not]
												[filter_wml]
													flying=yes
												[/filter_wml]
											[/not]
										[/filter]
										amount=20
										damage_type=impact
										fire_event=yes
										animate=yes
									[/harm_unit]
								[/then]
							[/if]
						[/else]
					[/if]
				{NEXT i}
				{CLEAR_VARIABLE target}
				{CLEAR_VARIABLE affected_location}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Earthquake}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Snakebite
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.debuff yes}
		{VARIABLE spell_cast.name "Snakebite"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=hiss-big.wav
				[/sound]
				[delay]
					time=100
				[/delay]
				[sound]
					name=bite.ogg
				[/sound]
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=8
					damage_type=pierce
					fire_event=yes
					animate=yes
					poisoned=yes
				[/harm_unit]
				{CLEAR_VARIABLE target}
				{VARIABLE finished yes}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Snakebite}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Frost Blast
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.debuff yes}
		{VARIABLE spell_cast.name "Frost Blast"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=magic-dark.ogg
				[/sound]
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=10
					damage_type=cold
					fire_event=yes
					animate=yes
					slowed=yes
				[/harm_unit]
				{CLEAR_VARIABLE target}
				{VARIABLE finished yes}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Frost Blast"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Ruthless Denial
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.name "Ruthless Denial"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				{CLEAR_VARIABLE spell_list}
				{VARIABLE spell_list.message _"These are all of side $victim.side|'s spells. Which would you like to discard?"}
				{VARIABLE spell_list.speaker narrator}
				{VARIABLE spell_list.side_for $side_number}
				{FOREACH $victim.side|.spells.option i}
# The first option is the option to not cast spells, so we're going to ignore that one. All the rest are fair game.
					[if]
						{MW_VARIABLE i greater_than 0}
						[then]
							[set_variables]
								name=spell_list.option
								mode=append
								[value]
							message=$$victim.side|.spells.option[$i].message
									[command]
										[message]
											speaker=narrator
											side_for=$side_number
											message= _ "$$victim.side|.spells.option[$i].name| discarded successfully."
										[/message]
										[message]
											speaker=narrator
											side_for=$victim.side
											message= _ "Side $side_number| has discarded one of your spells - $$victim.side|.spells.option[$i].name|!"
										[/message]
										{MW_DISCARD_SPELL $victim.side $$victim.side|.spells.option[$i].name}
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
				{NEXT i}
				[insert_tag]
					name=message
					variable=spell_list
				[/insert_tag]
				{VARIABLE finished yes}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Ruthless Denial"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Debunk
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.name "Debunk"}
		[if]
			{MW_VARIABLE $victim.side|.hidden_spells.option.length greater_than 1}
			[then]
				{CLEAR_VARIABLE spell_list}
				{VARIABLE spell_list.message _"These are all of side $victim.side|'s hidden spells. Which would you like to disarm?"}
				{VARIABLE spell_list.speaker narrator}
				{VARIABLE spell_list.side_for $side_number}
				{FOREACH $victim.side|.hidden_spells.option s}
					[if]
						{MW_VARIABLE s not_equals 0}
						[then]
							[set_variables]
								name=spell_list.option
								mode=append
								[value]
									message=$$victim.side|.hidden_spells.option[$s].message
									[command]
										[message]
											speaker=narrator
											side_for=$side_number
											message= _ "$$victim.side|.hidden_spells.option[$s].name| disarmed successfully."
										[/message]
										[message]
											speaker=narrator
											side_for=$victim.side
											message= _ "Side $side_number| has disarmed one of your hidden spells - $$victim.side|.hidden_spells.option[$s].name|!"
										[/message]
										{VARIABLE spell_to_disarm $$victim.side|.hidden_spells.option[$s].name}
										{VARIABLE side_to_uncurse $$victim.side|.hidden_spells.option[$s].cursed_side}
									[/command]
								[/value]
							[/set_variables]
						[/then]
					[/if]
				{NEXT s}
				[insert_tag]
					name=message
					variable=spell_list
				[/insert_tag]
				{MW_REMOVE_CURSE $side_to_uncurse $spell_to_disarm}
				{MW_DISARM_HIDDEN_SPELL $victim.side $spell_to_disarm}
				{VARIABLE finished yes}
			[/then]
			[else]
				[message]
					speaker=narrator
					side_for=$side_number
					message= _ "This side does not have any hidden spells."
				[/message]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Power Flow
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.name "Power Flow"}
		{MW_DESTROY_SPELLS_TO_FUEL 3}
		[if]
			{MW_VARIABLE spells_left_to_destroy equals 0}
			[then]
				{MW_CHECK_FOR_COUNTERS}
				[if]
					{MW_VARIABLE spell_cast.canceled not_equals yes}
					[then]
						{MW_CLEAR_SPELL $side_number "Power Flow"}
						{MW_CHANGE_MANA $side_number 20}
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "By destroying 3 spells, you have gained 20 mana."
						[/message]
					[/then]
				[/if]
			[/then]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Null and Void
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.hidden yes}
		{VARIABLE spell_cast.counter yes}
		{VARIABLE spell_cast.name "Null and Void"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[set_variables]
					name=$side_number|.hidden_spells.option
					mode=append
					[value]
						name= _ "Null and Void"
						counter=yes
						cursed_side=$victim.side
						message={MENU_IMG_TXT "attacks/circle-destr.png" _"Null and Void ($$side_number|.cost.null_and_void mana, hidden spell)
		Cancel the next spell cast by the target mage, and destroy it instead of discarding it
		Currently targeted at the mage of side $victim.side|"}
					[/value]
				[/set_variables]
				[set_variables]
					name=$victim.side|.curses.option
					mode=append
					[value]
						name= _ "Null and Void"
# Some more things that usually don't go in [option]. Good thing the keys don't have to be valid, it's still stored in the WML without screwing up the tag.
						counter=yes
						hidden=yes
						destroy=yes
						casting_side=$side_number
						message={MENU_IMG_TXT "attacks/circle-destr.png" _"Null and Void ($$side_number|.cost.null_and_void mana, hidden spell)
		Cancel the next spell cast by the target mage, and destroy it instead of discarding it
		Currently targeted at the mage of side $victim.side|"}
					[/value]
				[/set_variables]
				[message]
					speaker=narrator
					side_for=$side_number
					message= _ "Null and Void activated successfully. If not disarmed, it will cancel the next spell cast by side $victim.side|."
				[/message]
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Null and Void"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Dispel Malice
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.hidden yes}
		{VARIABLE spell_cast.counter yes}
		{VARIABLE spell_cast.name "Dispel Malice"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[set_variables]
					name=$side_number|.hidden_spells.option
					mode=append
					[value]
						name= _ "Dispel Malice"
						counter=yes
						message={MENU_IMG_TXT "attacks/aura-fire.png" _"Dispel Malice ($$side_number|.cost.dispel_malice mana, hidden spell)
		Cancel the next damaging spell cast by the target mage
		Currently targeted at the mage of side $victim.side|"}
					[/value]
				[/set_variables]
				[set_variables]
					name=$victim.side|.curses.option
					mode=append
					[value]
						name= _ "Dispel Malice"
						counter=yes
						hidden=yes
						casting_side=$side_number
						[counter_for]
							damaging=yes
						[/counter_for]
						message={MENU_IMG_TXT "attacks/aura-fire.png" _"Dispel Malice ($$side_number|.cost.dispel_malice mana, hidden spell)
		Cancel the next damaging spell cast by the target mage
		Currently targeted at the mage of side $victim.side|"}
					[/value]
				[/set_variables]
				[message]
					speaker=narrator
					side_for=$side_number
					message= _ "Dispel Malice activated successfully. If not disarmed, it will cancel the next damaging spell cast by side $victim.side|."
				[/message]
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Dispel Malice"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Stasis
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{VARIABLE spell_cast.name "Stasis"}
# If the spell is being cast on an enemy, treat it as a debuff spell.
		[if]
			[have_unit]
				{MW_ENEMY_OF $side_number}
			[/have_unit]
			[then]
				{VARIABLE spell_cast.debuff yes}
			[/then]
		[/if]
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[scroll_to]
					x,y=$target.x,$target.y
				[/scroll_to]
				[sound]
					name=petrified.ogg
				[/sound]
				[floating_text]
					x,y=$target.x,$target.y
					text="<span color='cyan'>Stasis</span>"
				[/floating_text]
				[modify_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					[status]
						petrified=yes
					[/status]
					[abilities]
						{MW_ABILITY_SPELLPROOF}
					[/abilities]
					[variables]
						petrify_turns=2
						spellproof=2
					[/variables]
				[/modify_unit]
				{CLEAR_VARIABLE target}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Stasis}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Reap
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.damaging yes}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{VARIABLE spell_cast.name "Reap"}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[sound]
					name=wail.wav
				[/sound]
				{VARIABLE harm_amount $unit.max_hitpoints}
				{VARIABLE_OP harm_amount add -$unit.hitpoints}
				{VARIABLE_OP harm_amount multiply 0.4}
				{VARIABLE_OP harm_amount round 0}
				[harm_unit]
					[filter]
						x,y=$target.x,$target.y
					[/filter]
					amount=$harm_amount
					fire_event=yes
					animate=yes
				[/harm_unit]
				{CLEAR_VARIABLE target}
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number Reap}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Recall Command
		first_time_only=no
		{VARIABLE spell_cast yes}
		{VARIABLE spell_cast.side $side_number}
		{VARIABLE spell_cast.x $target.x}
		{VARIABLE spell_cast.y $target.y}
		{VARIABLE spell_cast.name "Recall Command"}
		{VARIABLE spell_cast.transposition yes}
		{MW_CHECK_FOR_COUNTERS}
		[if]
			{MW_VARIABLE spell_cast.canceled not_equals yes}
			[then]
				[store_locations]
					[not]
						[filter]
						[/filter]
					[/not]
					[and]
						[filter]
							side=$unit.side
							canrecruit=yes
						[/filter]
						radius=1 
					[/and]
					variable=random_location
				[/store_locations]
				[if]
					{MW_VARIABLE random_location.length not_equals 0}
					[then]
						{RANDOM 1..$random_location.length}
						{VARIABLE_OP random add -1}
						[scroll_to]
							x,y=$unit.x,$unit.y
						[/scroll_to]
						[floating_text]
							x,y=$unit.x,$unit.y
							text="<span color='cyan'>Recall Command</span>"
						[/floating_text]
						[teleport]
							x,y=$random_location[$random].x,$random_location[$random].y
							animate=yes
							clear_shroud=yes
							[filter]
								x,y=$unit.x,$unit.y
							[/filter]
						[/teleport]
						[sound]
							name=fanfare-short.wav
						[/sound]
						{CLEAR_VARIABLE target}
						{CLEAR_VARIABLE random_location}
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "There is no space next to the leader of this unit's side."
						[/message]
					[/else]
				[/if]
			[/then]
			[else]
				[if]
					{MW_VARIABLE spell_cast.destroyed equals yes}
					[then]
						{MW_DESTROY_SPELL $side_number "Recall Command"}
					[/then]
				[/if]
			[/else]
		[/if]
		{CLEAR_VARIABLE spell_cast}
	[/event]
	
	[event]
		name=Tremors
		first_time_only=no
		{VARIABLE $side_number|.tremors.x $target.x}
		{VARIABLE $side_number|.tremors.y $target.y}
		{VARIABLE $side_number|.tremors.duration 6}
		[floating_text]
			x,y=$target.x,$target.y
			text="<span color='cyan'>Tremors</span>"
		[/floating_text]
		[item]
			x,y=$target.x,$target.y
			image="scenery/slab1.png"
		[/item]
		[label]
			x,y=$target.x,$target.y
			label="Tremors"
		[/label]
		[store_locations]
			[not]
				x,y=$target.x,$target.y
				radius=5
			[/not]
			[and]
				x,y=$target.x,$target.y
				radius=6
			[/and]
			variable=label_location
		[/store_locations]
		{FOREACH label_location i}
			[label]
				x,y=$label_location[$i].x,$label_location[$i].y
				label="Tremors"
			[/label]
		{NEXT i}
	[/event]
#enddef

#define MW_SPELL_FIREBALL SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
# Worth noting here - "name" isn't something that goes in option normally, but I have it here to make identifying spells easier.
			name= _ "Fireball"
			message={MENU_IMG_TXT "attacks/fireball.png" _"Fireball ($$side_number|.cost.fireball mana)
		Inflict 12 fire damage to non-leader unit at target hex ($x1|,$y1|)"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.fireball}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Fireball on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Fireball"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.fireball}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT Fireball x,y=$target.x,$target.y}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/fireball.png"
				side_for={SIDE}
				message= _ "You have generated Fireball."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_COMBUSTIBOLT SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Combustibolt"
			message={MENU_IMG_TXT "attacks/explosion.png" _"Combustibolt ($$side_number|.cost.combustibolt mana, 4 discarded spells)
		Inflict 14 fire damage to all enemy non-leader units within 1 hex of $x1|,$y1|"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.combustibolt}
					{MW_VARIABLE $side_number|.discarded_spells.option.length greater_than 4}
					[have_unit]
						{MW_ENEMY_OF $side_number}
						[filter_location]
							x,y=$x1,$y1
							radius=1
						[/filter_location]
						{MW_NOT_SPELLPROOF}
					[/have_unit]
					[then]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Activate Combustibolt at $x1|,$y1|?"
							[option]
								message= _ "Yes"
								[command]
									{MW_DISCARD_SPELL $side_number "Combustibolt"}
									{MW_CHANGE_MANA $side_number -$$side_number|.cost.combustibolt}
									{VARIABLE target.x $x1}
									{VARIABLE target.y $y1}
									{MW_FIRE_EVENT Combustibolt}
								[/command]
							[/option]
							[option]
								message= _ "No"
							[/option]
						[/message]
						{CLEAR_VARIABLE victim}
					[/then]
					[else]
						[if]
							{MW_VARIABLE $side_number|.discarded_spells.length less_than_equal_to 4}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough discarded spells to fuel this spell."
								[/message]
							[/then]
							[else]
								[if]
									{MW_VARIABLE $side_number|.mana less_than $$side_number|.cost.combustibolt}
									[then]
										[message]
											speaker=narrator
											side_for=$side_number
											message= _ "Not enough mana to cast this spell."
										[/message]
									[/then]
									[else]
										[message]
											speaker=narrator
											side_for=$side_number
											message= _ "There is no valid target here."
										[/message]
									[/else]
								[/if]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/explosion.png"
				side_for={SIDE}
				message= _ "You have generated Combustibolt."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_POWER_FLOW SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Power Flow"
			message={MENU_IMG_TXT "attacks/thorns.png" _"Power Flow (3 discarded spells)
		Gain 20 mana
		After casting, this spell is destroyed instead of being discarded"}
			[command]
				[if]
# Don't forget, one of the options is there for leaving the menu, so we have to make sure we check to make sure there's one more spell than the amount we need (in this case, 3).
					{MW_VARIABLE $side_number|.discarded_spells.option.length greater_than 3}
					[then]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Activate Power Flow?"
							[option]
								message= _ "Yes"
								[command]
									{MW_FIRE_EVENT "Power Flow"}
								[/command]
							[/option]
							[option]
								message= _ "No"
							[/option]
						[/message]
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough discarded spells to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/thorns.png"
				side_for={SIDE}
				message= _ "You have generated Power Flow."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_THUNDERBOLT SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Thunderbolt"
			message={MENU_IMG_TXT "attacks/lightning.png" _"Thunderbolt ($$side_number|.cost.thunderbolt mana)
		Inflict 15 fire damage to non-leader unit at target hex ($x1|,$y1|)
		If target unit flies or is on water, it takes double damage
		If target unit is on water, adjacent enemies on water are also hit"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.thunderbolt}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Thunderbolt on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Thunderbolt"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.thunderbolt}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT Thunderbolt x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/lightning.png"
				side_for={SIDE}
				message= _ "You have generated Thunderbolt."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_NULL_AND_VOID SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Null and Void"
			message={MENU_IMG_TXT "attacks/circle-destr.png" _"Null and Void ($$side_number|.cost.null_and_void mana, hidden spell)
		Cancel the next spell cast by the target mage, and destroy it instead of discarding it"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.null_and_void}
					[then]
						[if]
							{MW_CURSOR_ON_ENEMY_MAGE}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Cast Null and Void on the mage of side $victim.side|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Null and Void"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.null_and_void}
											{MW_FIRE_EVENT "Null and Void"}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough mana to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/circle-destr.png"
				side_for={SIDE}
				message= _ "You have generated Null and Void."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_DISPEL_MALICE SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Dispel Malice"
			message={MENU_IMG_TXT "attacks/aura-fire.png" _"Dispel Malice ($$side_number|.cost.dispel_malice mana, hidden spell)
		Cancel the next damaging spell cast by the target mage"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.dispel_malice}
					[then]
						[if]
							{MW_CURSOR_ON_ENEMY_MAGE}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Cast Dispel Malice on the mage of side $victim.side|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Dispel Malice"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.dispel_malice}
											{MW_FIRE_EVENT "Dispel Malice"}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough mana to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/aura-fire.png"
				side_for={SIDE}
				message= _ "You have generated Dispel Malice."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_SHADOW_STRIKE SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Shadow Strike"
			message={MENU_IMG_TXT "attacks/claws-undead.png" _"Shadow Strike ($$side_number|.cost.shadow_strike mana)
		Inflict 8 chaotic blade damage and deep wound to non-leader unit at target hex ($x1|,$y1|)
		If the target unit is adjacent to at least one of its enemies, it takes double damage
		Undead units cannot get deep wound"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.frost_blast}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Shadow Strike on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Shadow Strike"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.shadow_strike}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT "Shadow Strike" x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/claws-undead.png"
				side_for={SIDE}
				message= _ "You have generated Shadow Strike."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_SNAKEBITE SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Snakebite"
			message={MENU_IMG_TXT "attacks/fangs-snake.png" _"Snakebite ($$side_number|.cost.snakebite mana)
		Inflict 8 pierce damage and poison to non-leader unit at target hex ($x1|,$y1|)"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.frost_blast}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Snakebite on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Snakebite"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.frost_blast}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT Snakebite x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/fangs-snake.png"
				side_for={SIDE}
				message= _ "You have generated Snakebite."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_RUTHLESS_DENIAL SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Ruthless Denial"
			message={MENU_IMG_TXT "attacks/touch-demon.png" _"Ruthless Denial ($$side_number|.cost.ruthless_denial mana)
		Look at all the spells of the target mage, then discard one of those spells"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.ruthless_denial}
					[then]
						[if]
							{MW_CURSOR_ON_ENEMY_MAGE}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Cast Ruthless Denial on the mage of side $victim.side|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Ruthless Denial"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.ruthless_denial}
											{MW_FIRE_EVENT "Ruthless Denial"}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough mana to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/touch-demon.png"
				side_for={SIDE}
				message= _ "You have generated Ruthless Denial."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_DEBUNK SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Debunk"
			message={MENU_IMG_TXT "attacks/lightfocus.png" _"Debunk ($$side_number|.cost.debunk mana)
		Look at all the hidden spells of the target mage, then disarm one of those spells
		This spell cannot be canceled"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.debunk}
					[then]
						[if]
							{MW_CURSOR_ON_ENEMY_MAGE}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Cast Debunk on the mage of side $victim.side|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Debunk"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.debunk}
											{MW_FIRE_EVENT "Debunk"}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough mana to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/lightfocus.png"
				side_for={SIDE}
				message= _ "You have generated Debunk."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_FROST_BLAST SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Frost Blast"
			message={MENU_IMG_TXT "attacks/iceball.png" _"Frost blast ($$side_number|.cost.frost_blast mana)
		Inflict 10 cold damage and slow to non-leader unit at target hex ($x1|,$y1|)"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.frost_blast}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Frost blast on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Frost Blast"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.frost_blast}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT "Frost Blast" x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/iceball.png"
				side_for={SIDE}
				message= _ "You have generated Frost Blast."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_STASIS SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Stasis"
			message={MENU_IMG_TXT "attacks/vortex.png" _"Stasis ($$side_number|.cost.stasis mana)
		Petrify non-mage unit at target hex ($x1|,$y1|) and grant it spellproof for two turns"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.stasis}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					{MW_CURSOR_NOT_ON_MAGE}
					[then]
						[if]
							[have_unit]
								[not]
									{MW_IS_MAGE}
								[/not]
							[/have_unit]
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Stasis on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Stasis"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.stasis}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT Stasis x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/vortex.png"
				side_for={SIDE}
				message= _ "You have generated Stasis."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_REAP SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Reap"
			message={MENU_IMG_TXT "units/undead/spectre.png" _"Reap ($$side_number|.cost.reap mana)
		Inflict 40% of the missing health of the target unit at ($x1|,$y1|) as typeless damage to that unit
		If this spell kills the target unit, its mana cost is refunded"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.reap}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Reap on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Reap"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.reap}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT "Reap" x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="units/undead/spectre.png"
				side_for={SIDE}
				message= _ "You have generated Reap."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_RECALL_COMMAND SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Recall Command"
			message={MENU_IMG_TXT "units/human-loyalists/general-leading.png" _"Recall Command ($$side_number|.cost.recall_command mana)
		Teleports target non-leader unit not on a village at ($x1|,$y1|) to its leader"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.recall_command}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER}
							[not]
								[have_location]
									x,y=$x1,$y1
									terrain=*^V*
								[/have_location]
							[/not]
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Recall Command on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Recall Command"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.recall_command}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT "Recall Command" x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="units/human-loyalists/general-leading.png"
				side_for={SIDE}
				message= _ "You have generated Recall Command."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_EARTHQUAKE SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Earthquake"
			message={MENU_IMG_TXT "attacks/crush-wose.png" _"Earthquake ($$side_number|.cost.earthquake mana)
		Inflict 18 impact damage to ALL non-flying, non-leader units on or adjacent to target hex ($x1|,$y1|)
		Mountains and villages on the affected area are turned into hills and ruins, respectively
		Any unit on terrain that is changed takes an additional 18 impact damage"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.earthquake}
					[then]
						{MW_STORE_UNIT victim x,y=$x1,$y1}
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Activate Earthquake at $x1|,$y1|?"
							[option]
								message= _ "Yes"
								[command]
									{MW_DISCARD_SPELL $side_number "Earthquake"}
									{MW_CHANGE_MANA $side_number -$$side_number|.cost.earthquake}
									{VARIABLE target.x $x1}
									{VARIABLE target.y $y1}
									{MW_FIRE_EVENT Earthquake}
								[/command]
							[/option]
							[option]
								message= _ "No"
							[/option]
						[/message]
						{CLEAR_VARIABLE victim}
					[/then]
					[else]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Not enough mana to cast this spell."
						[/message]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/crush-wose.png"
				side_for={SIDE}
				message= _ "You have generated Earthquake."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_SMITE SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Smite"
			message={MENU_IMG_TXT "attacks/lightbeam.png" _"Smite ($$side_number|.cost.smite mana)
		Inflict 10 arcane damage to non-leader unit at target hex ($x1|,$y1|)
		If the target unit has negative resistance to arcane, it cannot move on its next turn"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.smite}
					{MW_CURSOR_NOT_ON_SPELLPROOF}
					[then]
						[if]
							{MW_CURSOR_ON_NONLEADER_ENEMY}
							[then]
								{MW_STORE_UNIT victim x,y=$x1,$y1}
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Activate Smite on the $victim.type| at $x1|,$y1|?"
									[option]
										message= _ "Yes"
										[command]
											{MW_DISCARD_SPELL $side_number "Smite"}
											{MW_CHANGE_MANA $side_number -$$side_number|.cost.smite}
											{VARIABLE target.x $x1}
											{VARIABLE target.y $y1}
											{MW_FIRE_EVENT_UNIT "Smite" x,y=$x1,$y1}
										[/command]
									[/option]
									[option]
										message= _ "No"
									[/option]
								[/message]
								{CLEAR_VARIABLE victim}
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "There is no valid target here."
								[/message]
							[/else]
						[/if]
					[/then]
					[else]
						[if]
							{MW_CURSOR_ON_SPELLPROOF}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You cannot cast this spell on this unit - it is spellproof."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="attacks/lightbeam.png"
				side_for={SIDE}
				message= _ "You have generated Smite."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_SPELL_TREMORS SIDE
	[set_variables]
		name={SIDE}.spells.option
		mode=append
		[literal]
			name= _ "Tremors"
			message={MENU_IMG_TXT "scenery/slab1.png" _"Tremors ($$side_number|.cost.tremors mana)
		Inflict 4-6 impact damage to all non-flying units in the targeted area each turn for a day
		You can only have one Tremors active"}
			[command]
				[if]
					{MW_HAVE_MANA $$side_number|.cost.tremors}
					{MW_VARIABLE $side_number|.tremors.duration equals $empty}
					[then]
						[message]
							speaker=narrator
							side_for=$side_number
							message= _ "Activate Tremors at $x1|,$y1|?"
							[option]
								message= _ "Yes"
								[command]
									{MW_DISCARD_SPELL $side_number "Tremors"}
									{MW_CHANGE_MANA $side_number -$$side_number|.cost.tremors}
									{VARIABLE target.x $x1}
									{VARIABLE target.y $y1}
									{MW_FIRE_EVENT Tremors}
								[/command]
							[/option]
							[option]
								message= _ "No"
							[/option]
						[/message]
						{CLEAR_VARIABLE victim}
					[/then]
					[else]
						[if]
							{MW_VARIABLE $side_number|.tremors.duration not_equals $empty}
							[then]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "You still have Tremors active for $$side_number|.tremors.duration turns."
								[/message]
							[/then]
							[else]
								[message]
									speaker=narrator
									side_for=$side_number
									message= _ "Not enough mana to cast this spell."
								[/message]
							[/else]
						[/if]
					[/else]
				[/if]
			[/command]
		[/literal]
	[/set_variables]
	[if]
		{MW_VARIABLE announce_spell_generation equals yes}
		[then]
			[message]
				speaker=narrator
				image="scenery/slab1.png"
				side_for={SIDE}
				message= _ "You have generated Tremors."
			[/message]
		[/then]
	[/if]
#enddef

#define MW_ADD_SPELL NAME
	[set_variables]
		name=random_spell
		mode=append
		[value]
			name={NAME}
		[/value]
	[/set_variables]
#enddef

#define MW_GIVE_SPELL NAME SIDE
	{VARIABLE spell {NAME}}
	[switch]
		variable=spell
		[case]
			value="Fireball"
			{MW_SPELL_FIREBALL {SIDE}}
		[/case]
		[case]
			value="Snakebite"
			{MW_SPELL_SNAKEBITE {SIDE}}
		[/case]
		[case]
			value="Frost Blast"
			{MW_SPELL_FROST_BLAST {SIDE}}
		[/case]
		[case]
			value="Ruthless Denial"
			{MW_SPELL_RUTHLESS_DENIAL {SIDE}}
		[/case]
		[case]
			value="Thunderbolt"
			{MW_SPELL_THUNDERBOLT {SIDE}}
		[/case]
		[case]
			value="Shadow Strike"
			{MW_SPELL_SHADOW_STRIKE {SIDE}}
		[/case]
		[case]
			value="Power Flow"
			{MW_SPELL_POWER_FLOW {SIDE}}
		[/case]
		[case]
			value="Null and Void"
			{MW_SPELL_NULL_AND_VOID {SIDE}}
		[/case]
		[case]
			value="Dispel Malice"
			{MW_SPELL_DISPEL_MALICE {SIDE}}
		[/case]
		[case]
			value="Debunk"
			{MW_SPELL_DEBUNK {SIDE}}
		[/case]
		[case]
			value="Stasis"
			{MW_SPELL_STASIS {SIDE}}
		[/case]
		[case]
			value="Reap"
			{MW_SPELL_REAP {SIDE}}
		[/case]
		[case]
			value="Recall Command"
			{MW_SPELL_RECALL_COMMAND {SIDE}}
		[/case]
		[case]
			value="Earthquake"
			{MW_SPELL_EARTHQUAKE {SIDE}}
		[/case]
		[case]
			value="Smite"
			{MW_SPELL_SMITE {SIDE}}
		[/case]
		[case]
			value="Tremors"
			{MW_SPELL_TREMORS {SIDE}}
		[/case]
		[case]
			value="Combustibolt"
			{MW_SPELL_COMBUSTIBOLT {SIDE}}
		[/case]
	[/switch]
#enddef

#define MW_GENERATE_RANDOM_SPELL SIDE
	[if]
		{MW_HAVE_MAGE {SIDE} "Battlemage"}
		[then]
			{MW_ADD_SPELL "Fireball"}
			{MW_ADD_SPELL "Snakebite"}
			{MW_ADD_SPELL "Frost Blast"}
			{MW_ADD_SPELL "Null and Void"}
			[if]
				{MW_VARIABLE starting_spells equals no}
				[then]
					{MW_ADD_SPELL "Recall Command"}
					{MW_ADD_SPELL "Dispel Malice"}
					{MW_ADD_SPELL "Shadow Strike"}
					{MW_ADD_SPELL "Power Flow"}
					{MW_ADD_SPELL "Ruthless Denial"}
					{MW_ADD_SPELL "Thunderbolt"}
					{MW_ADD_SPELL "Earthquake"}
					{MW_ADD_SPELL "Reap"}
					{MW_ADD_SPELL "Stasis"}
					{MW_ADD_SPELL "Smite"}
					{MW_ADD_SPELL "Tremors"}
					{MW_ADD_SPELL "Combustibolt"}
					[if]
						{MW_VARIABLE random_spell_selection equals no}
						[then]
# Bigger chance of generating low-mana spells if your current mana is low.
							[if]
								{MW_VARIABLE {SIDE}|.mana less_than 20}
								[then]
									{MW_ADD_SPELL "Fireball"}
									{MW_ADD_SPELL "Snakebite"}
									{MW_ADD_SPELL "Frost Blast"}
									{MW_ADD_SPELL "Null and Void"}
									{MW_ADD_SPELL "Reap"}
# In addition, if you have at least 3 discarded spells, you have a higher chance of generating Power Flow.
									[if]
										{MW_VARIABLE {SIDE}|.discarded_spells.option.length greater_than 3}
										[then]
											{MW_ADD_SPELL "Power Flow"}
										[/then]
									[/if]
								[/then]
							[/if]
# More likely to generate spells if you can pay for them.
							[if]
								{MW_VARIABLE {SIDE}|.discarded_spells.option.length greater_than 4}
								[then]
									{MW_ADD_SPELL "Combustibolt"}
								[/then]
							[/if]
							[if]
								{MW_VARIABLE own_over_enemy greater_than 1}
								[then]
									{MW_ADD_SPELL "Reap"}
								[/then]
							[/if]
							[if]
								{MW_VARIABLE own_over_enemy less_than 1}
								[then]
									{MW_ADD_SPELL "Recall Command"}
								[/then]
							[/if]
# More mana, however, means you're more likely to draw powerful spells with high mana costs.
							[if]
								{MW_VARIABLE {SIDE}|.mana greater_than 50}
								[then]
									{MW_ADD_SPELL "Thunderbolt"}
									{MW_ADD_SPELL "Shadow Strike"}
									{MW_ADD_SPELL "Stasis"}
									{MW_ADD_SPELL "Earthquake"}
									{MW_ADD_SPELL "Tremors"}
								[/then]
							[/if]
						[/then]
					[/if]
				[/then]
			[/if]
		[/then]
	[/if]
	[set_variable]
		name=random_spell_list
		[join]
			variable=random_spell
			key=name
			separator=,
		[/join]
	[/set_variable]
	{VARIABLE_OP spell_to_grant rand $random_spell_list}
	{MW_GIVE_SPELL $spell_to_grant {SIDE}}
	{CLEAR_VARIABLE random_spell_list}
	{CLEAR_VARIABLE spell_to_grant}
#enddef

#define MW_SPELL_DEATH_EVENTS
	[event]
		name=die
		first_time_only=no
		[if]
			{MW_VARIABLE spell_cast equals yes}
			{MW_HAVE_MAGE $spell_cast.side "Battlemage"}
			[then]
				{MW_GENERATE_RANDOM_SPELL "$spell_cast.side|"}
			[/then]
		[/if]
		[if]
			{MW_VARIABLE spell_cast.name equals Reap}
			[then]
				{MW_CHANGE_MANA $spell_cast.side $$spell_cast.side|.cost.reap}
			[/then]
		[/if]
	[/event]
#enddef

#define MW_GRANT_MANA_AND_SPELLS
	[event]
		name=turn refresh
		first_time_only=no
		[if]
			{MW_VARIABLE mage_sides contains $side_number}
			{MW_VARIABLE turn_number not_equals 1}
			[then]
				{MW_STORE_UNIT mage side,canrecruit=$side_number,yes}
				{VARIABLE boost $mage.hitpoints}
				{VARIABLE_OP boost multiply 0.1}
				{VARIABLE hitpoints_over_ten $mage.hitpoints}
				{VARIABLE_OP hitpoints_over_ten divide 10}
				{VARIABLE counter 9}
				{VARIABLE enemy_worth 0}
				{VARIABLE enemy_sides 0}
				{VARIABLE own_worth 0}
				[while]
					{MW_VARIABLE counter greater_than 0}
					[do]
						[if]
							[have_unit]
								side=$counter
								{MW_ENEMY_OF $side_number}
								canrecruit=no
							[/have_unit]
							[then]
								{VARIABLE_OP enemy_sides add 1}
								{MW_STORE_UNIT enemy_unit (
									side=$counter
									canrecruit=no
								)}
								{FOREACH enemy_unit i}
									{VARIABLE_OP enemy_worth add $enemy_unit[$i].cost}
								{NEXT i}
								[store_gold]
									side=$counter
									variable=gold
								[/store_gold]
								{VARIABLE_OP enemy_worth add $gold}
							[/then]
						[/if]
						{VARIABLE_OP counter add -1}
					[/do]
				[/while]
				{VARIABLE_OP enemy_worth divide $enemy_sides}
				{MW_STORE_UNIT own_unit (
					side=$$side_number|.assisted_side
					canrecruit=no
				)}
				{FOREACH own_unit i}
					{VARIABLE_OP own_worth add $own_unit[$i].cost}
				{NEXT i}
				[store_gold]
					side=$counter
					variable=gold
				[/store_gold]
				{VARIABLE_OP own_worth add $gold}
				{VARIABLE own_over_enemy $own_worth}
				{VARIABLE enemy_over_own $enemy_worth}
				{VARIABLE_OP own_over_enemy divide $enemy_worth}
				{VARIABLE_OP enemy_over_own divide $own_worth}
				[if]
					{MW_VARIABLE enemy_over_own greater_than 3}
					[then]
						{VARIABLE enemy_over_own 3}
					[/then]
				[/if]
				{VARIABLE_OP boost multiply $enemy_over_own}
				[if]
					{MW_VARIABLE boost less_than $hitpoints_over_ten}
					[then]
						{VARIABLE boost $hitpoints_over_ten}
					[/then]
				[/if]
				{VARIABLE_OP boost round 0}
				{MW_CHANGE_MANA $side_number $boost}
				{VARIABLE $side_number|.life $mage.hitpoints}
				{MW_GENERATE_RANDOM_SPELL "$side_number|"}
			[/then]
		[/if]
	[/event]
#enddef

#define MW_SPELL_MENU
	[set_menu_item]
		id=spell_list
		description= _ "See all of your spells"
		[show_if]
			[have_unit]
				side=$side_number
				{MW_IS_MAGE}
			[/have_unit]
		[/show_if]
		[command]
			{VARIABLE finished no}
			[while]
				{MW_VARIABLE finished not_equals yes}
				[do]
					[insert_tag]
						name=message
						variable=$side_number|.spells
					[/insert_tag]
				[/do]
			[/while]
		[/command]
	[/set_menu_item]
	[set_menu_item]
		id=discarded_spell_list
		description= _ "See all of your discarded spells"
		[show_if]
			[have_unit]
				side=$side_number
				x,y=$x1,$y1
				{MW_IS_MAGE}
			[/have_unit]
		[/show_if]
		[command]
			{VARIABLE finished no}
			[while]
				{MW_VARIABLE finished not_equals yes}
				[do]
					[insert_tag]
						name=message
						variable=$side_number|.discarded_spells
					[/insert_tag]
				[/do]
			[/while]
		[/command]
	[/set_menu_item]
	[set_menu_item]
		id=hidden_spell_list
		description= _ "See all of your hidden spells"
		[show_if]
			[have_unit]
				side=$side_number
				x,y=$x1,$y1
				{MW_IS_MAGE}
			[/have_unit]
		[/show_if]
		[command]
			{VARIABLE finished no}
			[while]
				{MW_VARIABLE finished not_equals yes}
				[do]
					[insert_tag]
						name=message
						variable=$side_number|.hidden_spells
					[/insert_tag]
				[/do]
			[/while]
		[/command]
	[/set_menu_item]
	[set_menu_item]
		id=curses_list
		description= _ "See all curses you are afflicted by"
		[show_if]
			[have_unit]
				side=$side_number
				x,y=$x1,$y1
				{MW_IS_MAGE}
			[/have_unit]
		[/show_if]
		[command]
			{FOREACH $side_number|.curses.option t}
				[if]
					{MW_VARIABLE $side_number.curses.option[$t].hidden not_equals yes}
					[then]
						[set_variables]
							name=$side_number.shown_curses.option
							mode=append
							[value]
								message=$side_number.curses.option[$t].message
							[/value]
						[/set_variables]
					[/then]
				[/if]
			{NEXT t}
			{VARIABLE finished no}
			[while]
				{MW_VARIABLE finished not_equals yes}
				[do]
					[insert_tag]
						name=message
						variable=$side_number|.shown_curses
					[/insert_tag]
				[/do]
			[/while]
			{CLEAR_VARIABLE $side_number|.shown_curses}
		[/command]
	[/set_menu_item]
#enddef